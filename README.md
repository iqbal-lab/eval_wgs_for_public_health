[TOC]

# Hackathon 

## Working directories in cyloid

## Bam files QC

### Insilico mutations test (BAM QC)

These stats are gathered from VCF's generated by COMPASS (after STAMPY mapping).

| sample.id | num_actg | num_n   | num_same_as_ref | num_z   | num_hz | cov_mean | cov_median | cov_mode | cov_1 | cov_5 | cov_10 | 
|-----------|---------:|--------:|----------------:|--------:|-------:|---------:|-----------:|---------:|------:|------:|-------:| 
| h37rv-306 | 4282729  | 126908  | 4282580         | 1895    | 552    | 92.1     | 93.0       | 94       | 99.9  | 99.7  | 99.4   | 
| h37rv-192 | 4267452  | 141422  | 4267294         | 2658    | 862    | 53.1     | 53.0       | 51       | 99.9  | 99.6  | 99.0   | 
| h37rv-83  | 3888131  | 516786  | 3888014         | 6615    | 6570   | 19.3     | 16.0       | 13       | 99.8  | 97.0  | 82.4   | 
| h37rv-63  | 4219714  | 146105  | 4219577         | 45713   | 331    | 30.1     | 31.0       | 30       | 98.9  | 98.2  | 97.6   | 
| h37rv-25  | 2472710  | 1874845 | 2472638         | 63977   | 6962   | 6.7      | 6.0        | 5        | 97.9  | 66.6  | 20.4   | 
| h37rv-11  | 92861    | 2139221 | 92845           | 2179450 | 3201   | 1.3      | 1.0        | 0        | 50.0  | 3.5   | 0.1    | 




## Cortex vs platypus vs compass using 4 different references and 4 different samples

The references used are H37rv with {82,926,8844,87977} mutations introduced insilico
The samples used are h37rv type strains used in several miseq runs as controls, and they
have different number of reads. I lebelled them by the number of MB they occupy {63,83,192,306}.

| Field | Description |
|------:|:------------|
| ID | H37rv version |
| REF | Reference version|
| RIGHT_MUT_DETECTED_RIGHT_PLACE| Mutations matching **in silico** padded mutations | 
| PERC_TRU_POS | % of insilico mutations found |
| WRONG_MUT_DETECTED_RIGHT_PLACE | Mutations found not maching the in silico ones |
| QCFAIL_RIGHT_PLACE | insilico mutations that were nor called because of QC failure |
| MUT_WRONG_PLACE | Mutations found outside the in silico set |
| MUT_CALLED_REF | In silico position that match the reference, not the in silico mut |
| HETZ_RIGHT_PLACE| Hetz calls in in silico positions |
| MISSEDPOSITIONS | In silico positions that either don't have coverage or are not present as vcf records | 
| MUTSININDELS |in silico mutations that are found within the span of an insertion/deletion|



| VCaller  | ID        | REF   | RIGHT_MUT_DETECTED_RIGHT_PLACE | PERC_TRU_POS | WRONG_MUT_DETECTED_RIGHT_PLACE | QCFAIL_RIGHT_PLACE | MUT_WRONG_PLACE | MUT_CALLED_REF | HETZ_RIGHT_PLACE | MISSEDPOSITIONS | MUTSININDELS |       | 
|----------|-----------|-------|--------------------------------|--------------|--------------------------------|--------------------|-----------------|----------------|------------------|-----------------|--------------|-------| 
| Cortex   | h37rv-63  | 82    | 76                             | 92.6         | 0                              | 0                  | 44              | 0              | 1                | 5               | 0            |       | 
| PLATYPUS | h37rv-63  | 82    | 78                             | 95.1         | 0                              | 2                  | 61              | 0              | 0                | 2               | 0            |       | 
| COMPASS  | h37rv-63  | 82    | 78                             | 95.1         | 0                              | 3                  | 59              | 0              | 0                | 1               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-63  | 926   | 877                            | 94.7         | 0                              | 0                  | 44              | 0              | 7                | 42              | 0            |       | 
| PLATYPUS | h37rv-63  | 926   | 903                            | 97.5         | 0                              | 10                 | 61              | 0              | 0                | 13              | 0            |       | 
| COMPASS  | h37rv-63  | 926   | 890                            | 96.1         | 0                              | 25                 | 59              | 0              | 0                | 11              | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-63  | 8844  | 8297                           | 93.8         | 0                              | 20                 | 44              | 0              | 84               | 441             | 2            | 8842  | 
| PLATYPUS | h37rv-63  | 8844  | 8614                           | 97.3         | 0                              | 84                 | 61              | 0              | 1                | 145             | 0            |       | 
| COMPASS  | h37rv-63  | 8844  | 8465                           | 95.7         | 0                              | 292                | 59              | 0              | 2                | 87              | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-63  | 87977 | 81478                          | 92.6         | 0                              | 792                | 41              | 0              | 726              | 4950            | 53           | 87946 | 
| PLATYPUS | h37rv-63  | 87977 | 85540                          | 97.2         | 0                              | 798                | 59              | 0              | 4                | 1635            | 8            |       | 
| COMPASS  | h37rv-63  | 87977 | 84165                          | 95.6         | 0                              | 2764               | 57              | 12             | 33               | 1036            | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-83  | 82    | 52                             | 63.4         | 0                              | 0                  | 28              | 0              | 15               | 15              | 0            |       | 
| PLATYPUS | h37rv-83  | 82    | 67                             | 81.7         | 0                              | 8                  | 57              | 0              | 1                | 6               | 0            |       | 
| COMPASS  | h37rv-83  | 82    | 71                             | 86.5         | 0                              | 10                 | 46              | 0              | 2                | 1               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-83  | 926   | 634                            | 68.4         | 0                              | 0                  | 28              | 0              | 180              | 112             | 0            |       | 
| PLATYPUS | h37rv-83  | 926   | 809                            | 87.3         | 0                              | 77                 | 57              | 0              | 2                | 38              | 0            |       | 
| COMPASS  | h37rv-83  | 926   | 810                            | 87.4         | 0                              | 114                | 47              | 0              | 7                | 2               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-83  | 8844  | 5897                           | 66.6         | 0                              | 19                 | 27              | 0              | 1723             | 1197            | 8            |       | 
| PLATYPUS | h37rv-83  | 8844  | 7724                           | 87.3         | 0                              | 752                | 57              | 0              | 48               | 319             | 2            |       | 
| COMPASS  | h37rv-83  | 8844  | 7638                           | 86.3         | 0                              | 1191               | 46              | 0              | 108              | 15              | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-83  | 87977 | 56150                          | 63.8         | 1                              | 729                | 35              | 0              | 16305            | 14775           | 39           |       | 
| PLATYPUS | h37rv-83  | 87977 | 76349                          | 86.7         | 0                              | 7437               | 54              | 0              | 686              | 3502            | 48           |       | 
| COMPASS  | h37rv-83  | 87977 | 76141                          | 86.5         | 0                              | 11651              | 46              | 7              | 1072             | 178             | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-192 | 82    | 71                             | 86.5         | 0                              | 0                  | 53              | 0              | 5                | 6               | 0            |       | 
| PLATYPUS | h37rv-192 | 82    | 62                             | 75.6         | 0                              | 16                 | 65              | 0              | 0                | 4               | 0            |       | 
| COMPASS  | h37rv-192 | 82    | 78                             | 95.1         | 0                              | 4                  | 80              | 0              | 0                | 0               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-192 | 926   | 846                            | 91.3         | 0                              | 0                  | 53              | 0              | 27               | 53              | 0            |       | 
| PLATYPUS | h37rv-192 | 926   | 754                            | 81.4         | 0                              | 159                | 65              | 0              | 0                | 13              | 0            |       | 
| COMPASS  | h37rv-192 | 926   | 899                            | 97.0         | 0                              | 24                 | 80              | 0              | 1                | 3               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-192 | 8844  | 8032                           | 90.8         | 0                              | 22                 | 53              | 0              | 280              | 508             | 2            |       | 
| PLATYPUS | h37rv-192 | 8844  | 7127                           | 80.5         | 0                              | 1589               | 65              | 0              | 3                | 125             | 2            |       | 
| COMPASS  | h37rv-192 | 8844  | 8565                           | 96.8         | 0                              | 271                | 80              | 0              | 7                | 8               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-192 | 87977 | 78466                          | 89.1         | 0                              | 800                | 50              | 0              | 2442             | 6230            | 61           |       | 
| PLATYPUS | h37rv-192 | 87977 | 72392                          | 82.2         | 0                              | 14287              | 67              | 0              | 50               | 1243            | 26           |       | 
| COMPASS  | h37rv-192 | 87977 | 85216                          | 96.8         | 0                              | 2557               | 79              | 9              | 99               | 195             | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-306 | 82    | 75                             | 91.4         | 0                              | 0                  | 43              | 0              | 1                | 6               | 0            |       | 
| PLATYPUS | h37rv-306 | 82    | 75                             | 91.4         | 0                              | 4                  | 61              | 0              | 0                | 3               | 1            |       | 
| COMPASS  | h37rv-306 | 82    | 79                             | 96.3         | 0                              | 2                  | 70              | 0              | 0                | 1               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-306 | 926   | 862                            | 93.0         | 0                              | 0                  | 43              | 0              | 19               | 45              | 0            |       | 
| PLATYPUS | h37rv-306 | 926   | 842                            | 90.9         | 0                              | 76                 | 61              | 0              | 0                | 8               | 0            |       | 
| COMPASS  | h37rv-306 | 926   | 902                            | 97.4         | 0                              | 23                 | 70              | 0              | 0                | 1               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-306 | 8844  | 8162                           | 92.2         | 0                              | 21                 | 43              | 0              | 194              | 465             | 2            |       | 
| PLATYPUS | h37rv-306 | 8844  | 8017                           | 90.6         | 0                              | 728                | 61              | 0              | 1                | 98              | 0            |       | 
| COMPASS  | h37rv-306 | 8844  | 8600                           | 97.2         | 0                              | 237                | 70              | 0              | 2                | 7               | 0            |       | 
| _        | _         | _     | _                              | _            | _                              | _                  | _               | _              | _                | _               | _            |       | 
| Cortex   | h37rv-306 | 87977 | 79996                          | 90.9         | 0                              | 805                | 40              | 1              | 1559             | 5596            | 43           |       | 
| PLATYPUS | h37rv-306 | 87977 | 80090                          | 91.0         | 0                              | 6913               | 59              | 0              | 14               | 953             | 22           |       | 
| COMPASS  | h37rv-306 | 87977 | 85572                          | 97.2         | 0                              | 2204               | 68              | 10             | 73               | 191             | 0            |       | 

## Workbench (playing with vcf's)

There is a workbench setup (python app) in order to play and compare different VCF's.

### Basics
It is located in Cycloid (**/data2/users/ALL/HACKATHON/workbench**), demo:
```python
cd /data2/users/ALL/HACKATHON/workbench
python wb.py
1. 11
2. 192
3. 25
4. 306
5. 63
6. 83
Choose a bam version (Mbytes): 2
1. 82
2. 87977
3. 8844
4. 926
Choose a reference version (#Spiked mutations): 4
Variables cmp,ctx and plt have been loaded with information for the differnt variantcallers
----------------------------------------
Sample [COMPASS] vs ref [926] (1006 positions)
	MISSEDPOSITIONS: 3 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 899 positions
	HETZ_RIGHT_PLACE: 1 positions
	QCFAIL_RIGHT_PLACE: 24 positions
	MUT_WRONG_PLACE: 80 positions
--------------------------------------------
----------------------------------------
Sample [CORTEX] vs ref [926] (979 positions)
	MISSEDPOSITIONS: 53 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 846 positions
	HETZ_RIGHT_PLACE: 27 positions
	MUT_WRONG_PLACE: 53 positions
--------------------------------------------
----------------------------------------
Sample [PLATYPS] vs ref [926] (991 positions)
	MISSEDPOSITIONS: 13 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 754 positions
	QCFAIL_RIGHT_PLACE: 159 positions
	MUT_WRONG_PLACE: 65 positions
--------------------------------------------
```
When you execute wb.py first of all you must choose a reference and a bam file. After that, **three python variables** will be loaded with the information for the different callers, **cmp** for Compass, **ctx** for Cortex and **plt** for Platypus. NOTE: Not all the VCF records are stores in those variable, only the **classiffied  ones**.

Then an **IPython** console will be opened so you can interact with the three variables.

In the code above, you can see the contents of the three variables.

when printing a variable:

```python
print cmp
----------------------------------------
Sample [COMPASS] vs ref [926] (1006 positions)
	MISSEDPOSITIONS: 3 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 899 positions
	HETZ_RIGHT_PLACE: 1 positions
	QCFAIL_RIGHT_PLACE: 24 positions
	MUT_WRONG_PLACE: 80 positions
--------------------------------------------
```

In the heder we can see the sample name, the reference used, (in this case a reference with 926 in silico mutations) and the number of positions recorded from the vcf (1006).
Below, you can see the different classifications, and you can query them:

```python
In [1]: cmp.MISSEDPOSITIONS
Out[1]: {3931604, 3949076, 4201268}
```

### Displaying VCF records
If you want to see the vcf records:

```python
In [3]: cmp._QCFAIL_RIGHT_PLACE() # That will open /usr/bin/less with VCF record information

CMP: R00000371  127495  .       G       A       236.00  K0.90;z ABQ4=35.750;BCALL=N;BaseCounts=30,0,2,0;BaseCounts4=22,0,2,0;DM4=-1.410;DM4L=-1.627;DP=32;DP4=1,1,8,14;DPT4L=-4.363;DZ4=-1.354;DZ4L=-1.709;GC=77.230
-----------------------------
CMP: R00000371  334937  .       T       G       109.00  B1;f0.35        ABQ4=37.600;BCALL=G;BaseCounts=0,2,12,3;BaseCounts4=0,0,5,0;DM4=-2.575;DM4L=-4.838;DP=17;DP4=0,0,5,0;DPT4L=-31.339;DZ4=-2.467;DZ4L=-4.621;GC
-----------------------------
CMP: R00000371  338513  .       T       C       106.00  n5      ABQ4=35.000;BCALL=C;BaseCounts=2,8,0,0;BaseCounts4=0,4,0,0;DM4=-2.637;DM4L=-2.488;DP=11;DP4=0,0,2,2;DPT4L=-11.601;DZ4=-2.525;DZ4L=-2.490;GC=85.150;M
...
...
```

#### Displaying ALL vcf records:
use .show() method
#### Displaying only one record
use **[ ]** operator:
```python
In [23]: cmp[4241412]
Out[23]: 'CMP: R00000371\t4241413\t.\tT\tC\t232.00\tPASS\tABQ4=36.458;BCALL=C;BaseCounts=0,63,0,0;BaseCounts4=0,59,0,0;DM4=0.736;DM4L=0.451;DP=63;DP4=0,0,30,29;DPT4L=13.089;DZ4=0.694;DZ4L=0.175;GC=66.340;MQ=60;MQ4=60;PCALL4=1.000;PCONS4=1.000;SBR=0\tGT:DP\t1/1:59'

```

###  Intersecting VCF's
You can perform **intersections** operations as well with de **.intersect()** method:

```python
In [4]: cmp
Out[4]: 
----------------------------------------
Sample [COMPASS] vs ref [926] (1006 positions)
	MISSEDPOSITIONS: 3 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 899 positions
	HETZ_RIGHT_PLACE: 1 positions
	QCFAIL_RIGHT_PLACE: 24 positions
	MUT_WRONG_PLACE: 80 positions
--------------------------------------------

In [5]: ctx
Out[5]: 
----------------------------------------
Sample [CORTEX] vs ref [926] (979 positions)
	MISSEDPOSITIONS: 53 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 846 positions
	HETZ_RIGHT_PLACE: 27 positions
	MUT_WRONG_PLACE: 53 positions
--------------------------------------------

In [6]: ctx.intersect(cmp)
Out[6]: 
----------------------------------------
Sample [( CORTEX ^ COMPASS )] vs ref [926] (979 positions)
	MISSEDPOSITIONS: 3 positions
	MUT_WRONG_PLACE: 53 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 845 positions
--------------------------------------------

```
### VCF union and difference

You can perform set union and set substraction as well:

```python
In [11]: cmp - ctx
Out[11]: 
----------------------------------------
Sample [( COMPASS - CORTEX )] vs ref [926] (27 positions)
	MUT_WRONG_PLACE: 27 positions
--------------------------------------------

In [12]: cmp + plt
Out[12]: 
----------------------------------------
Sample [( COMPASS U PLATYPS )] vs ref [926] (1013 positions)
	MISSEDPOSITIONS: 13 positions
	MUT_WRONG_PLACE: 87 positions
	QCFAIL_RIGHT_PLACE: 174 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 906 positions
--------------------------------------------
```

### VCF Subsetting

If you want just a subset of several positions from your VCF you can use **[]** operator to do that:

```python
In [15]: print cmp.QCFAIL_RIGHT_PLACE
set([3712385, 127494, 4060302, 3712153, 3735839, 623911, 1276841, 2439595, 1170480, 3947313, 1277618, 1191839, 2196161, 2029125, 1990470, 338512, 334936, 1619033, 3931099, 2551019, 2302448, 890739, 2973180, 3796094])

In [16]: print cmp.MISSEDPOSITIONS
set([3949076, 3931604, 4201268])

In [17]: print cmp.HETZ_RIGHT_PLACE
set([127494])

In [18]: cmp[[3712385,3949076,127494]]
Out[18]: 
----------------------------------------
Sample [COMPASS (subset)] vs ref [926] (3 positions)
	MISSEDPOSITIONS: 1 positions
	HETZ_RIGHT_PLACE: 1 positions
	QCFAIL_RIGHT_PLACE: 2 positions
--------------------------------------------
```

You can do useful things like **How did QCFAIL_RIGHT_PLACE positions in PLATYPUS perform in COMPASS**??

```python
In [22]: cmp[plt.QCFAIL_RIGHT_PLACE]
Out[22]: 
----------------------------------------
Sample [COMPASS (subset)] vs ref [926] (159 positions)
	QCFAIL_RIGHT_PLACE: 9 positions
	RIGHT_MUT_DETECTED_RIGHT_PLACE: 150 positions
--------------------------------------------
```

